image: modm/modm-build:latest

stages:
  - unittest
  - build
  - test

variables:
  LANG: "en_US.UTF-8"
  SCONS_LIB_DIR: "/usr/local/lib/python3.6/dist-packages/scons-3.0.1"
  SCONSFLAGS: "-j3"
  GIT_SUBMODULE_STRATEGY: recursive

unittest:
  stage: unittest
  script:
    - env
    - locale -a
    - python  --version || true
    - python2 --version || true
    - python3 --version || true
    - which scons
    - scons --version
    - which avr-g++
    - avr-g++ --version
    - which arm-none-eabi-g++
    - arm-none-eabi-g++ --version
    - (cd test && make test-hosted-linux)
    - (cd test && make test-stm32)
    - (cd test && make test-avr)
    - python2 tools/scripts/authors.py --handles --count --shoutout --since 2017-01-01
    - python3 tools/scripts/authors.py --handles --count --shoutout --since 2017-01-01
    - python2 tools/system_design/builder/system_layout.py examples/communication/xml/communication.xml -o /tmp
    - python3 tools/system_design/builder/system_layout.py examples/communication/xml/communication.xml -o /tmp

build:stm32f0-f1-examples:
  stage: build
  script:
    - (cd examples && ../tools/scripts/examples_compile.py stm32f0_discovery stm32f072_discovery nucleo_f031k6 stm32f030f4p6_demo_board)
    - (cd examples && ../tools/scripts/examples_compile.py stm32f1_discovery nucleo_f103rb olimexino_stm32 stm32f103c8t6_blue_pill)

build:stm32f3-f4-f7-examples:
  stage: build
  script:
    - (cd examples && ../tools/scripts/examples_compile.py stm32f3_discovery nucleo_f303k8)
    - (cd examples && ../tools/scripts/examples_compile.py stm32f746g_discovery)
    - (cd examples && ../tools/scripts/examples_compile.py stm32l476_discovery nucleo_l476rg)

build:stm32f4-examples:
  stage: build
  script:
    - (cd examples && ../tools/scripts/examples_compile.py stm32f4_discovery)
    - (cd examples && ../tools/scripts/examples_compile.py stm32f429_discovery stm32f469_discovery nucleo_f401re nucleo_f411re nucleo_f429zi)

build:avr-examples:
  stage: build
  script:
    - (cd examples && ../tools/scripts/examples_compile.py avr arduino_uno)

build:generic-examples:
  stage: build
  script:
    - (cd examples && ../tools/scripts/examples_compile.py generic)

build:linux-examples:
  stage: build
  script:
    - (cd examples && ../tools/scripts/examples_compile.py linux zmq)


.build:compile-all: &job_definition
  stage: build
  script:
    - (cd test/all && python3 run_all.py $SERIES)
  artifacts:
    paths:
      - test/all/log

build:avr-compile-all:
  variables:
    SERIES: at
  <<: *job_definition

build:stm32f0-compile-all:
  variables:
    SERIES: stm32f0
  <<: *job_definition

build:stm32f1-compile-all:
  variables:
    SERIES: stm32f1
  <<: *job_definition

build:stm32f2-compile-all:
  variables:
    SERIES: stm32f2
  <<: *job_definition

build:stm32f3-compile-all:
  variables:
    SERIES: stm32f3
  <<: *job_definition

build:stm32f4-compile-all:
  variables:
    SERIES: stm32f4
  <<: *job_definition

build:stm32f7-compile-all:
  variables:
    SERIES: stm32f7
  <<: *job_definition

build:stm32l4-compile-all:
  variables:
    SERIES: stm32l4
  <<: *job_definition
