.job: &common_job
  docker:
    - image: modm/modm-build:latest
  environment:
    - LANG: "en_US.UTF-8"
    - SCONS_LIB_DIR: "/usr/local/lib/python3.6/dist-packages/scons-3.0.1"
    - SCONSFLAGS: "-j3"
    - MAKEFLAGS: "-j3"

version: 2
jobs:
  unittests:
    <<: *common_job
    steps:
      - checkout
      - run: git submodule sync && git submodule update --init
      - run:
          name: Check environment
          command: |
            env
            locale -a
            python --version  || true
            python2 --version || true
            python3 --version || true
            which scons
            scons --version
            which avr-g++
            avr-g++ --version
            which arm-none-eabi-g++
            arm-none-eabi-g++ --version
      - run:
          name: Hosted Unittests
          command: |
            (cd test && make run-hosted-linux)
      - run:
          name: Compile STM32 Unittests
          command: |
            (cd test && make compile-nucleo-f103)
            (cd test && make compile-nucleo-f401)
            (cd test && make compile-nucleo-f411)
      - run:
          name: Compile AVR Unittests
          command: |
            (cd test && make compile-al-avreb-can)
      - run:
          name: Execute Python Scripts
          command: |
            python2 tools/scripts/authors.py --handles --count --shoutout --since 2017-01-01
            python3 tools/scripts/authors.py --handles --count --shoutout --since 2017-01-01
            python2 tools/xpcc_generator/builder/system_layout.py examples/xpcc/xml/communication.xml -o /tmp
            python3 tools/xpcc_generator/builder/system_layout.py examples/xpcc/xml/communication.xml -o /tmp

  stm32-examples:
    <<: *common_job
    steps:
      - checkout
      - run: git submodule sync && git submodule update --init
      - run:
          name: Examples STM32F0 Boards
          command: |
            (cd examples && ../tools/scripts/examples_compile.py stm32/disco_f072rb)
      - run:
          name: Examples STM32F1 Boards
          command: |
            (cd examples && ../tools/scripts/examples_compile.py stm32/blue_pill)
      - run:
          name: Examples STM32F3 Boards
          command: |
            (cd examples && ../tools/scripts/examples_compile.py stm32/disco_f303vc)
      - run:
          name: Examples STM32F7 Boards
          command: |
            (cd examples && ../tools/scripts/examples_compile.py stm32/disco_f746ng stm32/disco_f769ni)

  stm32f4-examples:
    <<: *common_job
    steps:
      - checkout
      - run: git submodule sync && git submodule update --init
      - run:
          name: Examples STM32F4 Boards
          command: |
            (cd examples && ../tools/scripts/examples_compile.py stm32/disco_f407vg stm32/disco_f469ni)

  stm32-nucleo-examples:
    <<: *common_job
    steps:
      - checkout
      - run: git submodule sync && git submodule update --init
      - run:
          name: Examples STM32 NUCLEO Boards
          command: |
            (cd examples && ../tools/scripts/examples_compile.py stm32/nucleo)

  avr-examples:
    <<: *common_job
    steps:
      - checkout
      - run: git submodule sync && git submodule update --init
      - run:
          name: Examples AVRs
          command: |
            (cd examples && ../tools/scripts/examples_compile.py avr)

  generic-examples:
    <<: *common_job
    steps:
      - checkout
      - run: git submodule sync && git submodule update --init
      - run:
          name: Generic Examples
          command: |
            (cd examples && ../tools/scripts/examples_compile.py generic)
      - run:
          name: Examples Linux
          command: |
            (cd examples && ../tools/scripts/examples_compile.py linux zmq)

  avr-compile-all:
    <<: *common_job
    steps:
      - checkout
      - run: git submodule sync && git submodule update --init
      - run:
          name: Compile HAL for all AVRs
          command: |
            (cd test/all && python3 run_all.py at)
      - store_artifacts:
          path: test/all/log
          destination: log

  stm32f0-compile-all:
    <<: *common_job
    steps:
      - checkout
      - run: git submodule sync && git submodule update --init
      - run:
          name: Compile HAL for all STM32F0
          command: |
            (cd test/all && python3 run_all.py stm32f0)
      - store_artifacts:
          path: test/all/log
          destination: log

  stm32f1-compile-all:
    <<: *common_job
    steps:
      - checkout
      - run: git submodule sync && git submodule update --init
      - run:
          name: Compile HAL for all STM32F1
          command: |
            (cd test/all && python3 run_all.py stm32f1)
      - store_artifacts:
          path: test/all/log
          destination: log

  stm32f2-compile-all:
    <<: *common_job
    steps:
      - checkout
      - run: git submodule sync && git submodule update --init
      - run:
          name: Compile HAL for all STM32F2
          command: |
            (cd test/all && python3 run_all.py stm32f2)
      - store_artifacts:
          path: test/all/log
          destination: log

  stm32f3-compile-all:
    <<: *common_job
    steps:
      - checkout
      - run: git submodule sync && git submodule update --init
      - run:
          name: Compile HAL for all STM32F3
          command: |
            (cd test/all && python3 run_all.py stm32f3)
      - store_artifacts:
          path: test/all/log
          destination: log

  stm32f4-compile-all:
    <<: *common_job
    steps:
      - checkout
      - run: git submodule sync && git submodule update --init
      - run:
          name: Compile HAL for all STM32F4
          command: |
            (cd test/all && python3 run_all.py stm32f4)
      - store_artifacts:
          path: test/all/log
          destination: log

  stm32f7-compile-all:
    <<: *common_job
    steps:
      - checkout
      - run: git submodule sync && git submodule update --init
      - run:
          name: Compile HAL for all STM32F7
          command: |
            (cd test/all && python3 run_all.py stm32f7)
      - store_artifacts:
          path: test/all/log
          destination: log

  stm32l4-compile-all:
    <<: *common_job
    steps:
      - checkout
      - run: git submodule sync && git submodule update --init
      - run:
          name: Compile HAL for all STM32L4
          command: |
            (cd test/all && python3 run_all.py stm32l4)
      - store_artifacts:
          path: test/all/log
          destination: log

workflows:
  version: 2
  build:
    jobs:
      - unittests
      - stm32f4-examples
      - stm32-examples
      - stm32-nucleo-examples
      - avr-examples
      - generic-examples

      - avr-compile-all:
          requires:
            - unittests
            - avr-examples
      - stm32f0-compile-all:
          requires:
            - unittests
            - stm32-examples
      - stm32f1-compile-all:
          requires:
            - unittests
            - stm32-examples
      - stm32f2-compile-all:
          requires:
            - unittests
      - stm32f3-compile-all:
          requires:
            - unittests
            - stm32-examples
      - stm32f4-compile-all:
          requires:
            - unittests
            - stm32f4-examples
      - stm32f7-compile-all:
          requires:
            - unittests
            - stm32-examples
      - stm32l4-compile-all:
          requires:
            - unittests
            - stm32-examples
