version: 2
jobs:
  unittests:
    docker:
      - image: modm/modm-build:latest
    environment:
      - LANG: "en_US.UTF-8"
      - SCONS_LIB_DIR: "/usr/local/lib/python3.6/dist-packages/scons-3.0.1"
      - SCONSFLAGS: "-j3"
    steps:
      - checkout
      - run: git submodule sync && git submodule update --init
      - run:
          name: Check environment
          command: |
            env
            locale -a
            python --version  || true
            python2 --version || true
            python3 --version || true
            which scons
            scons --version
            which avr-g++
            avr-g++ --version
            which arm-none-eabi-g++
            arm-none-eabi-g++ --version

      - run:
          name: Unittests
          command: |
            (cd test && make test-hosted-linux)
            (cd test && make test-stm32)
            (cd test && make test-avr)
            python2 tools/scripts/authors.py --handles --count --shoutout --since 2017-01-01
            python3 tools/scripts/authors.py --handles --count --shoutout --since 2017-01-01
            python2 tools/system_design/builder/system_layout.py examples/communication/xml/communication.xml -o /tmp
            python3 tools/system_design/builder/system_layout.py examples/communication/xml/communication.xml -o /tmp

  stm32f0/f1-examples:
    docker:
      - image: modm/modm-build:latest
    environment:
      - LANG: "en_US.UTF-8"
      - SCONS_LIB_DIR: "/usr/local/lib/python3.6/dist-packages/scons-3.0.1"
      - SCONSFLAGS: "-j3"
    steps:
      - checkout
      - run: git submodule sync && git submodule update --init
      - run:
          name: Examples STM32F0 Series
          command: |
            (cd examples && ../tools/scripts/examples_compile.sh stm32f0_discovery stm32f072_discovery nucleo_f031k6)
            (cd examples && ../tools/scripts/examples_compile.sh stm32f1_discovery nucleo_f103rb olimexino_stm32)

  stm32f3/l4/f7-examples:
    docker:
      - image: modm/modm-build:latest
    environment:
      - LANG: "en_US.UTF-8"
      - SCONS_LIB_DIR: "/usr/local/lib/python3.6/dist-packages/scons-3.0.1"
      - SCONSFLAGS: "-j3"
    steps:
      - checkout
      - run: git submodule sync && git submodule update --init
      - run:
          name: Examples STM32F3 Series
          command: |
            (cd examples && ../tools/scripts/examples_compile.sh stm32f3_discovery nucleo_f303k8)
            (cd examples && ../tools/scripts/examples_compile.sh stm32f746g_discovery)
            (cd examples && ../tools/scripts/examples_compile.sh stm32l476_discovery nucleo_l476rg)

  stm32f4-examples:
    docker:
      - image: modm/modm-build:latest
    environment:
      - LANG: "en_US.UTF-8"
      - SCONS_LIB_DIR: "/usr/local/lib/python3.6/dist-packages/scons-3.0.1"
      - SCONSFLAGS: "-j3"
    steps:
      - checkout
      - run: git submodule sync && git submodule update --init
      - run:
          name: Examples STM32F4 Series (except STM32F4 Discovery Board)
          command: |
            (cd examples && ../tools/scripts/examples_compile.sh stm32f4_discovery)
            (cd examples && ../tools/scripts/examples_compile.sh stm32f429_discovery stm32f469_discovery nucleo_f401re nucleo_f411re nucleo_f429zi)

  avr-examples:
    docker:
      - image: modm/modm-build:latest
    environment:
      - LANG: "en_US.UTF-8"
      - SCONS_LIB_DIR: "/usr/local/lib/python3.6/dist-packages/scons-3.0.1"
      - SCONSFLAGS: "-j3"
    steps:
      - checkout
      - run: git submodule sync && git submodule update --init
      - run:
          name: Examples ATmega Series
          command: |
            (cd examples && ../tools/scripts/examples_compile.sh avr arduino_uno)

  generic-examples:
    docker:
      - image: modm/modm-build:latest
    environment:
      - LANG: "en_US.UTF-8"
      - SCONS_LIB_DIR: "/usr/local/lib/python3.6/dist-packages/scons-3.0.1"
      - SCONSFLAGS: "-j3"
    steps:
      - checkout
      - run: git submodule sync && git submodule update --init
      - run:
          name: Examples from the generic folder (Mostly STM32 examples)
          command: |
            (cd examples && ../tools/scripts/examples_compile.sh generic)

  linux-examples:
    docker:
      - image: modm/modm-build:latest
    environment:
      - LANG: "en_US.UTF-8"
      - SCONS_LIB_DIR: "/usr/local/lib/python3.6/dist-packages/scons-3.0.1"
      - SCONSFLAGS: "-j3"
    steps:
      - checkout
      - run: git submodule sync && git submodule update --init
      - run:
          name: Examples Linux
          command: |
            (cd examples && ../tools/scripts/examples_compile.sh linux zmq)

workflows:
  version: 2
  build:
    jobs:
      - stm32f4-examples
      - linux-examples
      - unittests
      - stm32f3/l4/f7-examples
      - avr-examples
      - stm32f0/f1-examples
      - generic-examples
