name: Run tests on Linux

on: [pull_request]

jobs:
  unittests-linux-generic:
    runs-on: ubuntu-20.04
    container:
      image: ghcr.io/modm-ext/modm-build-cortex-m:2022-01-20

    steps:
      - name: Check out repository
        uses: actions/checkout@v2
      - name: Update submodules and install lbuild
        run: |
          (git submodule sync && git submodule update --init --jobs 8) & pip3 install --upgrade --upgrade-strategy=eager modm & wait
      - name: Check environment
        run: |
          env
          locale -a
          python --version  || true
          python3 --version || true
          python3 -c "import os; print(os.cpu_count())"
          which scons
          scons --version
          which g++
          g++ --version
          which arm-none-eabi-g++
          arm-none-eabi-g++ --version
          which lbuild
          lbuild --version
      - name: Check for Trailing Whitespace
        if: always()
        run: |
          python3 tools/scripts/rm_whitespace.py
      - name: Check for Expired Deprecations
        if: startsWith(github.head_ref, 'release/')
        run: |
          egrep -rI "DEPRECATED?:? +`basename ${{ github.head_ref }}`" .
          return $(egrep -rI "DEPRECATED?:? +`basename ${{ github.head_ref }}`" . | wc -l)
      - name: Synchronize Documentation
        if: always()
        run: |
          git checkout .
          python3 tools/scripts/synchronize_docs.py -d
