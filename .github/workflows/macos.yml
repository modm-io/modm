name: Run tests on MacOS

on: [pull_request]

jobs:
  macos_testing:
    runs-on: macos-13

    steps:
      - uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.2'

      - name: Setup environment - Brew tap
        run: |
          brew tap modm-ext/arm
          brew tap osx-cross/avr

      - name: Setup environment - Brew install
        run: |
          export HOMEBREW_NO_INSTALL_CLEANUP=1 # saves time
          brew update
          brew unlink gcc
          brew install doxygen boost gcc@12 avr-gcc@12 arm-gcc-bin@12 cmake || true
          brew link --force avr-gcc@12
          # brew upgrade boost gcc git || true

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Setup environment - Python pip
        run: |
          pip3 install --user modm scons
          echo "/usr/local/bin" >> $GITHUB_PATH
          echo "/Users/runner/Library/Python/3.11/bin" >> $GITHUB_PATH

      - name: Dump environment
        run: |
          echo $PATH
          env
          locale -a
          python --version  || true
          python3 --version || true
          python3 -c "import os; print(os.cpu_count())"
          which g++
          g++ --version
          which avr-g++
          avr-g++ --version
          which arm-none-eabi-g++
          arm-none-eabi-g++ --version
          which lbuild
          lbuild --version
          which scons
          scons --version

      - name: Check out repository
        if: always()
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'

      - name: Hosted Unittests
        if: always()
        run: |
          (cd test && make run-hosted-darwin)

      - name: Hosted Examples
        if: always()
        run: |
          (cd examples && ../tools/scripts/examples_compile.py linux)

      - name: Generic Examples
        if: always()
        run: |
          (cd examples && ../tools/scripts/examples_compile.py generic)

      - name: Compile STM32 Discovery Examples
        if: always()
        run: |
          (cd examples && ../tools/scripts/examples_compile.py stm32f0_discovery stm32f072_discovery stm32f1_discovery stm32f3_discovery stm32f4_discovery)
          (cd examples && ../tools/scripts/examples_compile.py stm32f401_discovery stm32f469_discovery stm32f746g_discovery stm32f769i_discovery)

      - name: Compile AVR Examples
        if: always()
        run: |
          (cd examples && ../tools/scripts/examples_compile.py avr arduino_nano arduino_uno srxe)
